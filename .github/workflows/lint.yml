name: lint-free
on: [push, pull_request]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        subdir: [web-app, machine-learning-client]

    steps:
      - uses: actions/checkout@v4

      - name: Check for Python files
        id: has_python
        run: |
          if ls ${{ matrix.subdir }}/*.py 1> /dev/null 2>&1; then
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.has_python.outputs.has_python == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        if: steps.has_python.outputs.has_python == 'true'
        run: |
          cd ${{ matrix.subdir }}
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Install pytest, pylint, black
        if: steps.has_python.outputs.has_python == 'true'
        run: |
          pip install pytest pytest-cov black pylint

      - name: Lint with pylint
        if: steps.has_python.outputs.has_python == 'true'
        run: |
          cd ${{ matrix.subdir }}
          pip install tomli
          pylint . || true

      - name: Check formatting with black
        if: steps.has_python.outputs.has_python == 'true'
        run: |
          cd ${{ matrix.subdir }}
          pip install tomli
          black --diff --check .

      - name: Run tests
        if: steps.has_python.outputs.has_python == 'true'
        run: |
          cd ${{ matrix.subdir }}
          if [ -d tests ]; then
            pytest --cov=. --cov-fail-under=0
          else
            echo "No tests found, skipping pytest"
          fi

/**
 * SitStraight – Tracking Page Script
 * -----------------------------------------------
 * Handles:
 * - Avatar animation (slider-based posture simulation)
 * - Timeline animation
 * - Live score updates
 * - Mode cycling (Desk / Walking / Focus)
 * - Failsafe checks so code never crashes
 *
 * Webcam + ML will plug into the "updateAvatarFromML()" function later.
 */

console.log("tracking.js loaded");

// ------------------------------------------------------------
// DOM ELEMENTS (safe lookup – no crashes)
// ------------------------------------------------------------
const spineEl = document.getElementById("spine");
const postureHalo = document.getElementById("postureHalo");
const slider = document.getElementById("postureSlider");
const sliderStateText = document.getElementById("sliderStateText");
const statusScore = document.getElementById("statusScore");
const streakValue = document.getElementById("streakValue");
const goodMinutes = document.getElementById("goodMinutes");
const modeLabel = document.getElementById("modeLabel");
const timelineIndicator = document.getElementById("timelineIndicator");

// Avoids errors if HTML is still incomplete
function exists(...els) {
  return els.every(el => el !== null && el !== undefined);
}

// ------------------------------------------------------------
// MODE SELECTION (Desk → Walking → Focus)
// ------------------------------------------------------------
const MODES = ["Desk", "Walking", "Focus"];
let modeIndex = 0;


// ------------------------------------------------------------
// Helper: Map slider value to posture state
// ------------------------------------------------------------
function mapSliderToState(value) {
  const v = parseFloat(value);
  if (v < -0.25) return "slouch";
  if (v > 0.25) return "tense";
  return "aligned";
}


// ------------------------------------------------------------
// Avatar Animation (spine bending + halo color)
// ------------------------------------------------------------
function updateAvatarFromSlider(value) {
  if (!exists(spineEl, postureHalo, sliderStateText)) return;

  const state = mapSliderToState(value);

  // Spine bending
  const maxBend = 14;
  const bend = maxBend * value;
  spineEl.style.transform =
    `translateX(-50%) skewX(${bend * -0.35}deg) rotate(${bend}deg)`;

  const blur = Math.abs(value) * 1.3;
  spineEl.style.filter =
    `drop-shadow(0 0 18px rgba(250,248,240,0.7)) blur(${blur}px)`;

  // Halo + text feedback
  if (state === "aligned") {
    sliderStateText.textContent = "Aligned";
    sliderStateText.style.color = "var(--accent-good)";
    postureHalo.style.borderColor = "rgba(78, 211, 139, 0.4)";
    postureHalo.style.boxShadow = "0 0 50px rgba(78, 211, 139, 0.5)";
  } else if (state === "slouch") {
    sliderStateText.textContent = "Lift your chest";
    sliderStateText.style.color = "var(--accent-bad)";
    postureHalo.style.borderColor = "rgba(255, 106, 106, 0.5)";
    postureHalo.style.boxShadow = "0 0 34px rgba(255, 106, 106, 0.45)";
  } else {
    sliderStateText.textContent = "Soften shoulders";
    sliderStateText.style.color = "var(--accent-neutral)";
    postureHalo.style.borderColor = "rgba(255, 207, 102, 0.4)";
    postureHalo.style.boxShadow = "0 0 40px rgba(255, 207, 102, 0.45)";
  }
}


// ------------------------------------------------------------
// Score animation (fake until ML is connected)
// ------------------------------------------------------------
function animateScore() {
  if (!statusScore || !slider) return;

  const base = 80;
  const wobble = Math.round(Math.random() * 8 - 4);
  const sliderOffset = Math.abs(parseFloat(slider.value)) * -10;
  const score = Math.max(60, Math.min(99, base + wobble + sliderOffset));

  statusScore.textContent = score;
}


// ------------------------------------------------------------
// Time statistics animation (fake data)
// ------------------------------------------------------------
function animateTimeStats() {
  if (!exists(goodMinutes, streakValue, slider)) return;

  const baseGood = 70;
  const adjust = Math.round((1 - Math.abs(parseFloat(slider.value))) * 12);
  const good = Math.max(40, Math.min(98, baseGood + adjust));

  goodMinutes.textContent = good;
  streakValue.textContent = String(Math.round(10 + Math.random() * 15));
}


// ------------------------------------------------------------
// Timeline animation (smooth indicator movement)
// ------------------------------------------------------------
function animateTimeline() {
  if (!timelineIndicator) return;

  const t = Date.now() / 1000;
  const phase = (Math.sin(t * 0.5) + 1) / 2;
  const offset = 20 + phase * 60;

  timelineIndicator.style.left = `${offset}%`;
}


// ------------------------------------------------------------
// Cycle mode label every 9 seconds
// ------------------------------------------------------------
function cycleMode() {
  if (!modeLabel) return;

  modeIndex = (modeIndex + 1) % MODES.length;
  modeLabel.textContent = MODES[modeIndex];
}


// ------------------------------------------------------------
// Slider → update avatar instantly
// ------------------------------------------------------------
if (slider) {
  slider.addEventListener("input", e => {
    updateAvatarFromSlider(e.target.value);
    animateScore();
    animateTimeStats();
  });
}


// ------------------------------------------------------------
// Continuous animations
// ------------------------------------------------------------
setInterval(() => {
  animateScore();
  animateTimeStats();
  cycleMode();
}, 9000);


// ------------------------------------------------------------
// Timeline animation loop
// ------------------------------------------------------------
function loop() {
  animateTimeline();
  requestAnimationFrame(loop);
}


// ------------------------------------------------------------
// Webcam / ML hook (OPTION C)
// ------------------------------------------------------------
/**
 * You can call this from your ML model:
 * updateAvatarFromML(leanAmount)
 *
 * leanAmount must be between -1 (slouch) and 1 (tense)
 */
export function updateAvatarFromML(leanValue) {
  updateAvatarFromSlider(leanValue);

  if (slider) slider.value = leanValue;

  animateScore();
  animateTimeStats();
}


// ------------------------------------------------------------
// Initialize page on load
// ------------------------------------------------------------
document.addEventListener("DOMContentLoaded", () => {
  if (slider) {
    updateAvatarFromSlider(slider.value);
  }

  animateScore();
  animateTimeStats();
  loop();
});
